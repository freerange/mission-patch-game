<!DOCTYPE html>
<html>
<head>
    <title>Mission Patch Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script>
    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        backgroundColor: '#0000ff',
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 800 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);

    var sticker = [];

    var tar;
    var stickersAtOnce = 3;

    var master;


    function preload ()
    {
        //Loads all assets
        this.load.image('laptop', 'assets/laptop-prot.png');
        this.load.image('target', 'assets/cursor.png');
        this.load.image('sky', 'assets/sky.png');
        this.load.image('patch', 'assets/patch.png')
    }

    function create ()
    {
        this.add.image(0, 0, 'sky').setOrigin(0, 0);

        //Launch Laptop
        laptops = this.physics.add.group();

        stickers = this.physics.add.group();

        this.physics.add.collider(laptops, laptops);
        this.physics.add.overlap(laptops, stickers, hitLaptop, null, this);

        var lap, lap2;

        function createLaptop(laptop, bounce, mode) {
          // Mode 0 = Bounce mode
          if(mode == 0) {
            laptop = laptops.create(Phaser.Math.Between(0, config.width /*- 100*/), Phaser.Math.Between(0, config.height /*- 50*/), 'laptop');
            laptop.setData({ laptopMode: mode });
            var velX = (laptop.x > (config.width/2)) ? -1 : 1;
            var velY = (laptop.y > (config.height/2)) ? -1 : 1;
            laptop.setVelocity(Phaser.Math.Between(400, 600) * velX, Phaser.Math.Between(400, 600) * velY);
            laptop.setBounce(bounce);
            laptop.setCollideWorldBounds(true);
          }
          //Mode 1 = Chuck mode
          else if(mode == 1) {
            var compX = Math.abs(Phaser.Math.Between(0, config.width) - (config.width/2));
            var compY = Math.abs(Phaser.Math.Between(0, config.height) - (config.height/2));

            var posX;
            var posY;

            if(compX < compY) {
              posX = (Phaser.Math.Between(0, config.width) > (config.width/2)) ? config.width : 0;
              posY = compY;
            }
            else if(compY < compX) {
              posX = compX;
              posY = (Phaser.Math.Between(0, config.height) > (config.height/2)) ? config.height : 0;
            }

            // var posX = (Phaser.Math.Between(0, config.width) > (config.width/2)) ? config.width : 0;
            // var posY = (Phaser.Math.Between(0, config.height) > (config.height/2)) ? config.height : 0;

            laptop = laptops.create(posX, posY, 'laptop');
            laptop.setData({ laptopMode: mode });

            var velX = (laptop.x > (config.width/2)) ? -1 : 1;
            var velY = (laptop.y > (config.height/2)) ? -1 : 1;
            laptop.setVelocity(Phaser.Math.Between(400, 600) * velX, Phaser.Math.Between(400, 600) * velY);
            laptop.setBounce(bounce);
          }
          else {
            console.log('The selected mode doesn\'t exist')
          }
        }

        createLaptop(lap, 0.99, 0);
        createLaptop(lap2, 0.95, 0);

        var laptopsLeft = laptops.children.entries.length;
        var scoreText;

        scoreText = this.add.text(16, 16, laptopsLeft + ' to go', {fontSize: '32px', fill: '#000' })

        tar = this.physics.add.staticSprite(0, 0, 'target').setOrigin(0, 0);

        master = this;

        //Sticker is prepped
        for(var i = 0; i < stickersAtOnce; i++) {

          sticker[i] = stickers.create(0, 0, 'patch');
          sticker[i].setData({ patchSticking: false, currentLaptop: -1, lapDiffX: 0, lapDiffY: 0 });
          sticker[i].scale = 0.8;
          sticker[i].setScale(sticker[i].scale, sticker[i].scale);
          sticker[i].disableBody(true, true);


        }

        function hitLaptop (lapt, stick) {
          for(var i = 0; i < sticker.length; i++) {
            if(stick.scale <= 0.1 && stick.data.values.patchSticking && lapt.body.collideWorldBounds) {
                laptopsLeft--;
                for(var i = 0; i < laptops.children.entries.length; i++) {
                  if(laptops.children.entries[i] == lapt) {
                    stick.data.values.currentLaptop = i;
                    stick.data.values.lapDiffX = stick.x - lapt.x;
                    stick.data.values.lapDiffY = stick.y - lapt.y;
                    stick.body.setAllowGravity(false);
                  }
                }

                if(laptopsLeft > 0)
                  scoreText.setText(laptopsLeft + ' to go');
                else
                  scoreText.setText('All laptops are Patched');

                lapt.disableBody(true, false);
                lapt.enableBody(true, lapt.x, lapt.y, true, true);

                lapt.setCollideWorldBounds(false);
            }
          }
        }

        //Follow center of reticle
        this.input.on('pointermove', function (pointer) {

            tar.x = pointer.x - (tar.width/2);
            tar.y = pointer.y - (tar.height/2);

        });


        var id;

        this.input.on('pointerdown', function (pointer) {

            for(var i = 0; i < sticker.length; i++) {
              if(sticker[i].y > config.height || sticker[i].active == false) {
                  sticker[i].enableBody(true, tar.x + ((sticker[i].width * sticker[i].scale)/2), tar.y + ((sticker[i].height * sticker[i].scale)/2), true, true);
                  sticker[i].data.values.patchSticking = true;

                  sticker[i].scale = 0.8;
                  sticker[i].setVelocity(0, -175);
                  break;
              }
            }

        });
    }

    function update ()
    {
      for(var i = 0; i < sticker.length; i++) {
        {
            if(sticker[i].scale > 0.1 && sticker[i].active == true && sticker[i].data.values.patchSticking) {
                sticker[i].scale -= 0.022;
                sticker[i].setScale(sticker[i].scale, sticker[i].scale);
            }
            else if(sticker[i].scale <= 0.1 && sticker[i].active == true && sticker[i].data.values.patchSticking) {
                sticker[i].disableBody(true, false);
                sticker[i].enableBody(true, sticker[i].x, sticker[i].y, true, true);
                sticker[i].data.values.patchSticking = false;
            }
        }

        //Keeps position relative to laptop it's sticking to until it leaves the screen
        if(sticker[i].data.values.currentLaptop != -1) {
          sticker[i].setPosition(laptops.children.entries[sticker[i].data.values.currentLaptop].x + sticker[i].data.values.lapDiffX, laptops.children.entries[sticker[i].data.values.currentLaptop].y + sticker[i].data.values.lapDiffY);
          if(sticker[i].y > config.height + sticker[i].height) {
            sticker[i].data.values.currentLaptop = -1;
            sticker[i].data.values.lapDiffX = 0;
            sticker[i].data.values.lapDiffY = 0;
            sticker[i].body.setAllowGravity(true);
          }
        }
      }
    }
    </script>

</body>
</html>
